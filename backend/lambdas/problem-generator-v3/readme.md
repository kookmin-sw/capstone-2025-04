# Problem Generator V2 리팩토링

## 개요

Problem Generator V2는 LLM을 사용하여 프로그래밍 문제를 자동 생성하는 AWS Lambda 기반 서비스입니다. 이 프로젝트는 최근 모놀리식 코드베이스에서 모듈화된 구조로 리팩토링되었습니다.

## 리팩토링 목표 및 성과

기존 `index.mjs` 파일(1086줄)은 모든 기능이 하나의 파일에 집중되어 있어 유지보수와 확장이 어려웠습니다. 리팩토링을 통해:

1. **관심사 분리**: 각 기능을 독립적인 모듈로 분리
2. **가독성 향상**: 각 모듈의 크기를 줄여 이해하기 쉽게 만듦
3. **테스트 용이성**: 개별 모듈을 독립적으로 테스트할 수 있는 구조 제공
4. **재사용성**: 공통 기능을 유틸리티 모듈로 분리하여 재사용 가능하게 함
5. **유지보수성**: 특정 기능을 수정할 때 관련 모듈만 변경하도록 구조화

## 폴더 구조

리팩토링된 코드는 다음과 같은 구조를 가집니다:

```
src/
├── handler.mjs            # Lambda 핸들러 진입점
├── services/              # 서비스 모듈
│   ├── pipeline.mjs       # 8단계 파이프라인 오케스트레이션
│   ├── dynamoClient.mjs   # DynamoDB CRUD 작업
│   └── sse.mjs            # SSE 스트리밍 기능
├── chains/                # LLM 체인 모듈
│   ├── intentAnalysis.mjs # 의도 분석 체인
│   ├── solutionGen.mjs    # 솔루션 생성 체인
│   ├── testGen.mjs        # 테스트 생성 체인
│   ├── validation.mjs     # 검증 체인
│   ├── constraints.mjs    # 제약 도출 체인
│   ├── description.mjs    # 설명 생성 체인
│   ├── title.mjs          # 제목 생성 체인
│   ├── translation.mjs    # 번역 체인
│   └── index.mjs          # 체인 배럴 파일
├── prompts/               # 프롬프트 템플릿
│   ├── intentAnalysis.mjs
│   ├── solutionGen.mjs
│   └── ... (기타 프롬프트 파일)
├── schemas/               # Zod 스키마
│   ├── intent.mjs
│   ├── validation.mjs
│   └── ... (기타 스키마 파일)
└── utils/                 # 유틸리티 함수
    ├── constants.mjs      # 환경 변수 및 상수
    ├── cleanLlmOutput.mjs # LLM 출력 정제
    └── retry.mjs          # 재시도 로직
```

## 모듈별 책임

### 1. Handler 모듈

- Lambda 이벤트를 수신하고 파이프라인으로 위임
- AWS Lambda 스트리밍 응답 설정

### 2. 서비스 모듈

- **pipeline.mjs**: 전체 문제 생성 워크플로우 조정
- **dynamoClient.mjs**: DynamoDB 상태 관리
- **sse.mjs**: 서버-전송 이벤트(SSE) 스트리밍 처리

### 3. 체인 모듈

- 각 LLM 단계에 대한 체인 정의
- 프롬프트와 출력 파서 조합
- 각 단계별 로직 분리

### 4. 스키마 모듈

- Zod로 구조화된 출력 스키마 정의
- LLM 출력 검증 및 타입 안전성 제공

### 5. 유틸리티 모듈

- 환경 변수 중앙화
- 공통 기능 추출 (텍스트 정제, 재시도 로직 등)

## 성능 개선 방법

이 리팩토링은 직접적인 런타임 성능 향상보다는 코드 품질과 유지보수성 개선에 초점을 맞추었습니다. 하지만 다음과 같은 성능 최적화 기회가 있습니다:

1. **캐싱 도입**:
   - 자주 재사용되는 프롬프트 결과 캐싱
   - DynamoDB 읽기/쓰기 최적화

2. **병렬 처리**:
   - 독립적인 단계(예: 제목 생성과 설명 번역)를 병렬로 실행

3. **토큰 최적화**:
   - 프롬프트 템플릿 크기 최적화
   - 필요한 컨텍스트만 LLM에 전달

4. **재시도 전략 개선**:
   - 지수 백오프와 지터 사용
   - 특정 오류 유형에 따른 선택적 재시도

## 참여 방법

팀원들이 코드 성능 개선에 참여할 수 있는 방법은 다음과 같습니다:

1. **모듈 최적화**:
   - 특정 모듈의 성능 프로파일링
   - 프롬프트 최적화 및 토큰 사용량 감소

2. **테스트 추가**:
   - 각 모듈의 단위 테스트 작성
   - 종단 간 통합 테스트 추가

3. **코드 리뷰**:
   - 기존 모듈 리뷰 및 개선 제안
   - 코드 중복 제거

4. **문서화**:
   - JSDoc 주석 추가 및 개선
   - 복잡한 로직에 대한 설명 추가

5. **새 기능 개발**:
   - 동일한 모듈화 패턴을 따라 새 기능 구현
   - 확장성을 고려한 설계 제안

## 시작하기

1. 코드 탐색하기:
   - `handler.mjs`에서 시작하여 진입점 이해
   - `services/pipeline.mjs`로 이동하여 전체 워크플로우 파악
   - 개별 체인 모듈 살펴보기

2. 개발 환경 설정:
   - 로컬 환경 변수 설정
   - 테스트 데이터 준비

3. 테스트하기:
   - 로컬에서 Lambda 호출 테스트
   - 개별 체인 단위 테스트

## 기여 가이드라인

1. 기존 모듈화 패턴 따르기
2. 함수 크기를 작게 유지하고 단일 책임 원칙 적용
3. 코드 변경 시 단위 테스트 포함
4. 변경 사항에 대한 문서 업데이트

리팩토링은 완료되었지만, 지속적인 개선이 필요합니다. 적극적인 참여를 환영합니다!
